<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direction Qibla - OSM</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
     
    <style>
        * {
            box-sizing: border-box;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        /* La carte doit prendre tout l'√©cran */
        #map {
            height: 100vh;
            width: 100vw;
        }

        /* Statut avec design moderne */
        #status {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.3px;
            backdrop-filter: blur(10px);
            animation: slideDown 0.5s ease-out;
        }

        /* Bouton de placement manuel */
        #manualPlaceBtn {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            color: #333;
            border: 2px solid #e0e0e0;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            outline: none;
        }

        #manualPlaceBtn:hover {
            background: #f5f5f5;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        #manualPlaceBtn:active {
            transform: translateY(0);
        }

        #manualPlaceBtn.active {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border-color: #11998e;
            box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4);
        }

        /* Style pour l'ic√¥ne de la Mecque */
        .mecca-icon {
            background: transparent;
            border: none;
            text-align: center;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        /* Personnalisation des popups Leaflet */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 2px;
        }

        .leaflet-popup-content {
            margin: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .leaflet-popup-tip {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Animation de chargement */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Personnalisation des contr√¥les de zoom */
        .leaflet-control-zoom a {
            border-radius: 8px !important;
            color: #667eea !important;
        }

        .leaflet-control-zoom a:first-child {
            border-radius: 8px 8px 0 0 !important;
        }

        .leaflet-control-zoom a:last-child {
            border-radius: 0 0 8px 8px !important;
        }

        /* Boutons de navigation en bas √† droite */
        .nav-buttons {
            position: absolute;
            bottom: 30px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .nav-btn {
            width: 50px;
            height: 50px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            outline: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn svg {
            width: 24px;
            height: 24px;
            fill: #667eea;
        }

        .nav-btn:hover {
            background: #f5f5f5;
            box-shadow: 0 4px 15px rgba(0,0,0,0.25);
            transform: scale(1.1);
        }

        .nav-btn:active {
            transform: scale(1);
        }

        /* Style responsive pour mobile */
        @media (max-width: 768px) {
            #status {
                top: 10px;
                font-size: 12px;
                padding: 10px 18px;
                max-width: 80%;
                text-align: center;
            }

            #manualPlaceBtn {
                top: 10px;
                right: 10px;
                padding: 8px 16px;
                font-size: 12px;
            }

            .nav-buttons {
                bottom: 20px;
                right: 15px;
                gap: 10px;
            }

            .nav-btn {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>

    <div id="status">Localisation en cours...</div>
    <button id="manualPlaceBtn">üìç Placer un point</button>

    <!-- Boutons de navigation -->
    <div class="nav-buttons">
        <button class="nav-btn" id="globalViewBtn" title="Vue g√©n√©rale">üåç</button>
        <button class="nav-btn" id="manualPointBtn" title="Point manuel" style="display: none;">üìç</button>
        <button class="nav-btn" id="myLocationBtn" title="Position GPS">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
            </svg>
        </button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <script>
        // Coordonn√©es de la Kaaba (La Mecque)
        const MECCA_LAT = 21.422487;
        const MECCA_LNG = 39.826206;

        // Initialisation de la carte (vue par d√©faut mondiale avant la g√©oloc)
        const map = L.map('map').setView([20, 0], 2);

        // Ajout des tuiles OpenStreetMap
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // Ic√¥ne personnalis√©e pour la Mecque (Optionnel)
        const meccaIcon = L.divIcon({
            html: '<div style="font-size: 24px;">üïã</div>',
            className: 'mecca-icon',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        // Marqueur sur la Mecque
        const meccaMarker = L.marker([MECCA_LAT, MECCA_LNG], {icon: meccaIcon}).addTo(map)
            .bindPopup("La Mecque (Kaaba)");

        // Variables pour le placement manuel et GPS
        let manualPlaceMode = false;
        let gpsMarker = null;
        let manualMarker = null;
        let gpsLine = null;
        let manualLine = null;
        let hasGpsLocation = false;

        // Fonction de succ√®s de g√©olocalisation
        function onLocationFound(position) {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            const userLatLng = [userLat, userLng];

            // Mettre √† jour le statut
            document.getElementById('status').innerText = "Direction trouv√©e !";
            hasGpsLocation = true;

            // 1. Ajouter le marqueur GPS de l'utilisateur
            gpsMarker = L.marker(userLatLng).addTo(map)
                .bindPopup("Position GPS")
                .openPopup();

            // 2. Cr√©er une ligne (Polyline) entre l'utilisateur et la Mecque
            // Note: C'est une ligne droite visuelle sur la projection Mercator.
            gpsLine = L.polyline([userLatLng, [MECCA_LAT, MECCA_LNG]], {
                color: 'green',
                weight: 5,
                opacity: 0.7,
                dashArray: '10, 10' // Ligne pointill√©e
            }).addTo(map);

            // 3. Ajuster la vue pour voir les deux points
            const bounds = L.latLngBounds([userLatLng, [MECCA_LAT, MECCA_LNG]]);
            map.fitBounds(bounds, { padding: [50, 50] });
        }

        // Fonction d'erreur
        function onLocationError(error) {
            let msg = "Erreur de g√©olocalisation.";
            if(error.code === 1) msg = "Vous devez autoriser la g√©olocalisation.";
            document.getElementById('status').innerText = msg;
            console.error(error);
        }
        // Fonction pour placer un point manuellement
        function placeUserPoint(latlng) {
            // Supprimer l'ancien marqueur manuel et ligne s'ils existent
            if (manualMarker) {
                map.removeLayer(manualMarker);
            }
            if (manualLine) {
                map.removeLayer(manualLine);
            }

            // Cr√©er le nouveau marqueur manuel
            manualMarker = L.marker(latlng).addTo(map)
                .bindPopup("Point plac√© manuellement")
                .openPopup();

            // Cr√©er la ligne vers la Mecque
            manualLine = L.polyline([latlng, [MECCA_LAT, MECCA_LNG]], {
                color: 'blue',
                weight: 5,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(map);

            // Ajuster la vue
            const bounds = L.latLngBounds([latlng, [MECCA_LAT, MECCA_LNG]]);
            map.fitBounds(bounds, { padding: [50, 50] });

            // Mettre √† jour le statut
            document.getElementById('status').innerText = "Point plac√© - Direction vers la Mecque";

            // Afficher le bouton du point manuel
            document.getElementById('manualPointBtn').style.display = 'flex';
        }

        // Gestionnaire du bouton de placement manuel
        const manualPlaceBtn = document.getElementById('manualPlaceBtn');
        manualPlaceBtn.addEventListener('click', function() {
            manualPlaceMode = !manualPlaceMode;

            if (manualPlaceMode) {
                this.classList.add('active');
                this.innerText = "üìç Cliquez sur la carte";
                document.getElementById('status').innerText = "Cliquez sur la carte pour placer votre position";
                map.getContainer().style.cursor = 'crosshair';
            } else {
                this.classList.remove('active');
                this.innerText = "üìç Placer un point";
                map.getContainer().style.cursor = '';
            }
        });

        // Gestionnaire de clic sur la carte
        map.on('click', function(e) {
            if (manualPlaceMode) {
                placeUserPoint(e.latlng);

                // D√©sactiver le mode placement apr√®s avoir plac√© le point
                manualPlaceMode = false;
                manualPlaceBtn.classList.remove('active');
                manualPlaceBtn.innerText = "üìç Placer un point";
                map.getContainer().style.cursor = '';
            }
        });

        // Gestionnaire du bouton "Position GPS"
        const myLocationBtn = document.getElementById('myLocationBtn');
        myLocationBtn.addEventListener('click', function() {
            if (gpsMarker) {
                // Zoomer sur la position GPS
                const gpsLatLng = gpsMarker.getLatLng();
                map.setView(gpsLatLng, 15);
                gpsMarker.openPopup();
            } else {
                document.getElementById('status').innerText = "Aucune position GPS trouv√©e";
            }
        });

        // Gestionnaire du bouton "Point manuel"
        const manualPointBtn = document.getElementById('manualPointBtn');
        manualPointBtn.addEventListener('click', function() {
            if (manualMarker) {
                // Zoomer sur le point manuel
                const manualLatLng = manualMarker.getLatLng();
                map.setView(manualLatLng, 15);
                manualMarker.openPopup();
            }
        });

        // Gestionnaire du bouton "Vue g√©n√©rale"
        const globalViewBtn = document.getElementById('globalViewBtn');
        globalViewBtn.addEventListener('click', function() {
            // Prioriser le point manuel s'il existe, sinon GPS
            if (manualMarker && manualLine) {
                // Afficher la ligne compl√®te entre le point manuel et la Mecque
                const bounds = L.latLngBounds([manualMarker.getLatLng(), [MECCA_LAT, MECCA_LNG]]);
                map.fitBounds(bounds, { padding: [50, 50] });
            } else if (gpsMarker && gpsLine) {
                // Afficher la ligne compl√®te entre la position GPS et la Mecque
                const bounds = L.latLngBounds([gpsMarker.getLatLng(), [MECCA_LAT, MECCA_LNG]]);
                map.fitBounds(bounds, { padding: [50, 50] });
            } else {
                // Vue globale par d√©faut
                map.setView([20, 0], 2);
            }
        });

        // Lancer la g√©olocalisation
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(onLocationFound, onLocationError);
        } else {
            document.getElementById('status').innerText = "G√©olocalisation non support√©e par ce navigateur.";
        }
    </script>
</body>
</html>